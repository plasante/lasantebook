class Book < ActiveRecord::Base
  has_and_belongs_to_many :users

  attr_accessor :exists

  def Book.search_amazon( keyword , page , user_id )
    search = AmazonInterface.new
    results = search.find_by_keyword( keyword , page )
    return Book.convert_amazon_results( results , user_id )
  end

  def Book.convert_amazon_results( results , user_id )
    user = User.find( user_id )
    converted_books = Array.new
    results.each do |result|
      book = user.books.find_by_isbn( result.asin.to_s )
      if (book)
        book.exists = true
      else
        book = Book.new
        book.exists = false
      end
      book.title = result.item_attributes[0].title[0].to_s
      if result.item_attributes[0].author
        book.author = result.item_attributes[0].author.join(',')
      end
      book.release_date = result.item_attributes[0].publication_date.to_s
      if result.small_image
        book.image_url_small = result.small_image.url.to_s
      end
      if result.medium_image
        book.image_url_medium = result.medium_image.url.to_s
      end
      if result.large_image
        book.image_url_large = result.large_image.url.to_s
      end
      converted_books.push(book)
    end
    return converted_books
  end

  def after_find
    self.exists = true
  end
end
